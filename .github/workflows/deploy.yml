name: deploy-ssh
on:
 workflow_dispatch:
 release:
 types: [published]
concurrency:
 group: deploy-${{ github.ref }}
 cancel-in-progress: true
jobs:
 deploy:
 runs-on: ubuntu-latest
 steps:
 - name: Download app.zip from latest release
 uses: robinraju/release-downloader@v1.11
 with:
 repository: ${{ github.repository }}
 latest: true
 fileName: "app.zip"
 - name: Add server host key (pin)
 run: |
 mkdir -p ~/.ssh
 ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts
 env:
 SSH_HOST: ${{ secrets.SSH_HOST }}
 - name: Copy app.zip to server
 uses: appleboy/scp-action@v0.1.7
 with:
 host: ${{ secrets.SSH_HOST }}
 username: ${{ secrets.SSH_USER }}
 key: ${{ secrets.SSH_KEY }}
 source: "app.zip"
 target: "/srv/hello/"
 - name: Deploy via SSH (atomic release + systemd)
 uses: appleboy/ssh-action@v1.1.0
 with:
 host: ${{ secrets.SSH_HOST }}
 username: ${{ secrets.SSH_USER }}
 key: ${{ secrets.SSH_KEY }}
 script: |
 set -euo pipefail
 cd /srv/hello
 ts="$(date -u +%Y-%m-%dT%H-%M-%SZ)"
 mkdir -p "releases/$ts"
 unzip -o app.zip -d "releases/$ts"
 cd "releases/$ts"
 npm ci --omit=dev
 ln -sfn "/srv/hello/releases/$ts" /srv/hello/current
 sudo systemctl restart hello
 curl -fsS http://localhost:3000/health || (sudo journalctl -u
hello -n 200 --no-pager; exit 1)
 ls -1dt /srv/hello/releases/* | tail -n +6 | xargs -r rm -rf
